name: OIDC
on: [push]
permissions:
      id-token: write
      contents: read 
jobs:
  OIDC-AWS-READ:
    runs-on: ubuntu-latest
    env:
      aws-account: 444838350740
      aws-region: eu-west-3
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
 
      - name: AWS OIDC configure
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::${{ env.aws-account }}:role/gha-test
          aws-region: ${{ env.aws-region }}

      - name: Login to ECR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.aws-account }}.dkr.ecr.${{ env.aws-region }}.amazonaws.com

      - name: Build && Push container
        run: |
          # docker build . -t wolfi:gha
          # docker tag wolfi:gha 444838350740.dkr.ecr.eu-west-3.amazonaws.com/wolfi:oidc
          docker pull 444838350740.dkr.ecr.eu-west-3.amazonaws.com/wolfi:1
          docker run 444838350740.dkr.ecr.eu-west-3.amazonaws.com/wolfi:1 cat /etc/os-release

      - name: S3 bucket list
        run: |
          aws s3 ls
